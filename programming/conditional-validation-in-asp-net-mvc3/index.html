



<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Paul Heasley">
  

  <title>Conditional Validation in ASP.NET MVC3 | phdesign</title>
  <meta name="description" content="Need to perform validation on a model’s property based on some other state of the model? Here’s a way to achieve it using the IValidatableObject interface an...">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="http://phdesign.com.au/programming/conditional-validation-in-asp-net-mvc3/">
  <link rel="alternate" type="application/rss+xml" title="phdesign" href="/feed.xml">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MTPZZRZTVF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MTPZZRZTVF');
</script>


  

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

  <body class="post">

    <div class="header-background-image"></div>
    <header role="banner">
      <div class="header-top">
        
<nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/" title="phdesign homepage">ph<span class="brand-muted">design</span></a>
    </div><!-- end .navbar-header -->

    <div class="collapse navbar-collapse" id="navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/">Home <span class="sr-only">(current)</span></a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Blog <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            
              <li><a href="/programming">programming</a></li>
            
              <li><a href="/general">general</a></li>
            
              <li><a href="/woodworking">woodworking</a></li>
            
              <li><a href="/infosec">infosec</a></li>
            
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Projects <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/album-rsync">album-rsync</a></li>
            <li><a href="/npptoolbucket">NppToolBucket</a></li>
            <li><a href="/betternote">BetterNote</a></li>
            <li><a href="/phreplace">phReplace</a></li>
          </ul>
        </li>
        <li><a href="/presentations">Presentations</a></li>
        <li><a href="/contact">Contact me</a></li>
      </ul>

    </div><!-- end .navbar-collapse -->
  </div><!-- end .container -->
</nav>

      </div><!-- end .header-top -->

      

    </header>
    <main class="content" aria-label="Content">
  	  <article>
  <div class="container">

    <div class="date-stamp">
      <div class="month">Jun</div>
      <div class="day">10</div>
    </div><!-- end .date-stamp -->

    <h2 class="post-header">Conditional Validation in ASP.NET MVC3</h2>

    <div class="meta-label">
      posted on <span class="meta-value muted">10 June 2011</span>
      
        in <span class="meta-value"><a href="/programming">programming</a></span>
      
    </div><!-- end .meta-label -->
    <br />

    
    
    
    
      <p class="deprecated alert alert-warning"><b>Warning:</b> Please consider that this post is over 13 years old and the content may no longer be relevant.</p>
    

    <p>Need to perform validation on a model’s property based on some other state of the model? Here’s a way to achieve it using the IValidatableObject interface and data annotations.</p>

<!--more-->

<p>In our example project we want to validate the state field is a valid Australian state if the country field is “Australia”.</p>

<p><img src="/assets/img/blog/conditional-validation-in-asp-net-mvc3/ConditionalValidationSmall.png" alt="Conditional validation of state field" /></p>

<h2 id="ivalidatableobject">IValidatableObject</h2>
<p>Any model that implements IValidatableObject in MVC3 (note this doesn’t work in MVC2) will get it’s Validate method called when validating the object.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span><span class="err"> </span><span class="k">abstract</span><span class="err"> </span><span class="k">class</span><span class="err"> </span><span class="nc">ModelBase</span><span class="err"> </span><span class="p">:</span><span class="err"> </span><span class="n">IValidatableObject</span>
<span class="p">...</span>
<span class="k">public</span> <span class="n">IEnumerable</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">ValidationContext</span> <span class="n">validationContext</span><span class="p">)</span></code></pre></figure>

<h2 id="conditionalvalidationattribute">ConditionalValidationAttribute</h2>
<p>To define the conditional validation we’ll use a ConditionalValidationAttribute which identifies a method to call to perform the validation. The method must be static, accept at least one parameter (the value of the property to be validated), optionally accept a second context parameter (this will be the object whose property is being validated) and return a ValidationResult.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[ConditionalValidation(typeof(User), "ValidateState")]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">State</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">...</span>
<span class="k">public</span> <span class="k">static</span> <span class="n">ValidationResult</span> <span class="nf">ValidateState</span><span class="p">(</span><span class="kt">string</span> <span class="n">state</span><span class="p">,</span> <span class="kt">object</span> <span class="n">context</span><span class="p">)</span></code></pre></figure>

<h2 id="modelbase">ModelBase</h2>
<p>The ModelBase class brings this all together. The constructor builds a dictionary of ConditionalValidationAttributes for each property and it implements the IValidatableObject.Validate method to loop through all the ConditionalValidationAttributes and validate them.</p>

<p>Note that the IValidatableObject.Validate method is called after all data annotations have been successfully validated. So if you have some properties with a RequiredAttribute, the required field error message will show and the user will need to fix this before our model’s Validate messages are displayed.</p>

<p>Here’s the full code for <strong>ModelBase.cs</strong>:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ModelBase</span> <span class="p">:</span> <span class="n">IValidatableObject</span>
<span class="p">{</span>
  <span class="c1">/// &lt;summary&gt;
</span>  <span class="c1">/// The list of validations for each property
</span>  <span class="c1">/// &lt;/summary&gt;
</span>  <span class="k">protected</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ConditionalValidationAttribute</span><span class="p">[</span><span class="k">]&gt;</span> <span class="n">Validations</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">protected</span> <span class="nf">ModelBase</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">Validations</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">property</span> <span class="k">in</span> <span class="nf">GetType</span><span class="p">().</span><span class="nf">GetProperties</span><span class="p">()</span>
             <span class="k">let</span> <span class="n">validations</span> <span class="p">=</span> <span class="nf">GetValidations</span><span class="p">(</span><span class="n">property</span><span class="p">)</span>
             <span class="k">where</span> <span class="n">validations</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span>
             <span class="k">select</span> <span class="k">new</span> <span class="p">{</span><span class="n">PropertyName</span> <span class="p">=</span> <span class="n">property</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Validations</span> <span class="p">=</span> <span class="n">validations</span><span class="p">})</span>
      <span class="p">.</span><span class="nf">ToDictionary</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">PropertyName</span><span class="p">,</span> <span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">Validations</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt;
</span>  <span class="c1">/// Validates all ConditionalValidationAttributes
</span>  <span class="c1">/// &lt;/summary&gt;
</span>  <span class="c1">/// &lt;param name=&amp;quot;validationContext&amp;quot;&gt;&lt;/param&gt;
</span>  <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;
</span>  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ValidationResult</span><span class="p">&gt;</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">ValidationContext</span> <span class="n">validationContext</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">from</span> <span class="n">property</span> <span class="k">in</span> <span class="n">Validations</span>
         <span class="k">from</span> <span class="n">validator</span> <span class="k">in</span> <span class="n">property</span><span class="p">.</span><span class="n">Value</span>
         <span class="k">select</span> <span class="n">validator</span><span class="p">.</span><span class="nf">IsValid</span><span class="p">(</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="n">property</span><span class="p">.</span><span class="n">Key</span><span class="p">),</span> <span class="k">this</span><span class="p">)</span>
         <span class="k">into</span> <span class="n">validationResult</span>
         <span class="k">where</span> <span class="n">validationResult</span> <span class="p">!=</span> <span class="n">ValidationResult</span><span class="p">.</span><span class="n">Success</span>
         <span class="k">select</span> <span class="n">validationResult</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="err">#</span><span class="n">region</span> <span class="n">Private</span> <span class="p">&amp;</span> <span class="n">Protected</span> <span class="n">Methods</span>

  <span class="c1">/// &lt;summary&gt;
</span>  <span class="c1">/// Gets the validation attributes attached to a property.
</span>  <span class="c1">/// &lt;/summary&gt;
</span>  <span class="c1">/// &lt;param name=&amp;quot;property&amp;quot;&gt;The property.&lt;/param&gt;
</span>  <span class="c1">/// &lt;returns&gt;An array of validation attributes.&lt;/returns&gt;
</span>  <span class="k">private</span> <span class="k">static</span> <span class="n">ConditionalValidationAttribute</span><span class="p">[]</span> <span class="nf">GetValidations</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="nf">GetCustomAttributes</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ConditionalValidationAttribute</span><span class="p">),</span> <span class="k">true</span><span class="p">)</span>
      <span class="p">.</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">ConditionalValidationAttribute</span><span class="p">&gt;().</span><span class="nf">ToArray</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt;
</span>  <span class="c1">/// Gets the value for a property.
</span>  <span class="c1">/// &lt;/summary&gt;
</span>  <span class="c1">/// &lt;param name=&amp;quot;propertyName&amp;quot;&gt;The property name.&lt;/param&gt;
</span>  <span class="c1">/// &lt;returns&gt;The value of the property as an object.&lt;/returns&gt;
</span>  <span class="k">protected</span> <span class="kt">object</span> <span class="nf">GetPropertyValue</span><span class="p">(</span><span class="kt">string</span> <span class="n">propertyName</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="nf">GetType</span><span class="p">().</span><span class="nf">GetProperty</span><span class="p">(</span><span class="n">propertyName</span><span class="p">).</span><span class="nf">GetValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">TargetInvocationException</span> <span class="n">exception</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">InnerException</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="n">exception</span><span class="p">.</span><span class="n">InnerException</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="err">#</span><span class="n">endregion</span>
<span class="p">}</span></code></pre></figure>

<p>Note that when we call the ConditionalValidationAttribute.IsValid method we pass in ‘this’ as the context so we have a reference to the object being validated.</p>

<p><strong>ConditionalValidationAttribute.cs</strong>:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[AttributeUsage(AttributeTargets.Class | AttributeTargets.Property)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ConditionalValidationAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
<span class="p">{</span>
  <span class="err">#</span><span class="n">region</span> <span class="n">Fields</span>

  <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">_methodInfo</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="kt">bool</span> <span class="n">_isSingleArgumentMethod</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">_valuesType</span><span class="p">;</span>

  <span class="err">#</span><span class="n">endregion</span>

  <span class="err">#</span><span class="n">region</span> <span class="n">Properties</span>

  <span class="k">public</span> <span class="kt">string</span> <span class="n">ErrorMessage</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">Method</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="n">Type</span> <span class="n">ValidatorType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="err">#</span><span class="n">endregion</span>

  <span class="err">#</span><span class="n">region</span> <span class="n">Constructor</span>

  <span class="c1">/// &lt;summary&gt;
</span>  <span class="c1">/// Performs validation by calling a specified static method with one of the following signatures:
</span>  <span class="c1">/// ValidationResult Method(object value)
</span>  <span class="c1">/// ValidationResult Method(object value, object context)
</span>  <span class="c1">/// The value parameter may be strongly typed, if a process passes a value of a different type, type conversion will be attempted.
</span>  <span class="c1">/// &lt;/summary&gt;
</span>  <span class="c1">/// &lt;param name=&amp;quot;validatorType&amp;quot;&gt;The type that contains the method that performs custom validation.&lt;/param&gt;
</span>  <span class="c1">/// &lt;param name=&amp;quot;method&amp;quot;&gt;The method that performs custom validation.&lt;/param&gt;
</span>  <span class="k">public</span> <span class="nf">ConditionalValidationAttribute</span><span class="p">(</span><span class="n">Type</span> <span class="n">validatorType</span><span class="p">,</span> <span class="kt">string</span> <span class="n">method</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">method</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;);</span>

    <span class="n">Method</span> <span class="p">=</span> <span class="n">method</span><span class="p">;</span>
    <span class="n">ValidatorType</span> <span class="p">=</span> <span class="n">validatorType</span><span class="p">;</span>
    <span class="c1">// Find a matching method - if multiple matching methods, pick the one with 2 parameters.
</span>    <span class="kt">var</span> <span class="n">methods</span> <span class="p">=</span> <span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">validatorType</span><span class="p">.</span><span class="nf">GetMethods</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">p</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="nf">GetParameters</span><span class="p">().</span><span class="n">Length</span>
            <span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">method</span> <span class="p">&amp;&amp;</span>
              <span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ValidationResult</span><span class="p">)</span> <span class="p">&amp;&amp;</span>
              <span class="p">(</span><span class="n">p</span> <span class="p">==</span> <span class="m">1</span> <span class="p">||</span> <span class="n">p</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span>
            <span class="k">orderby</span> <span class="n">p</span> <span class="k">descending</span>
            <span class="k">select</span> <span class="n">m</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">methods</span><span class="p">.</span><span class="nf">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">No</span> <span class="n">method</span> <span class="p">&amp;</span><span class="err">#</span><span class="m">39</span><span class="p">;{</span><span class="m">0</span><span class="p">}&amp;</span><span class="err">#</span><span class="m">39</span><span class="p">;</span> <span class="n">found</span> <span class="k">in</span> <span class="k">class</span> <span class="err">&amp;#39;{1}&amp;#39;</span> <span class="nc">with</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">signature</span><span class="p">.&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="n">method</span><span class="p">,</span> <span class="n">validatorType</span><span class="p">));</span>
    <span class="n">_methodInfo</span> <span class="p">=</span> <span class="n">methods</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">_methodInfo</span><span class="p">.</span><span class="nf">GetParameters</span><span class="p">();</span>
    <span class="n">_isSingleArgumentMethod</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">_valuesType</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">ParameterType</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="err">#</span><span class="n">endregion</span>

  <span class="err">#</span><span class="n">region</span> <span class="n">Public</span> <span class="n">Methods</span>

  <span class="k">public</span> <span class="n">ValidationResult</span> <span class="nf">IsValid</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">context</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">object</span> <span class="n">convertedValue</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">info</span> <span class="p">=</span> <span class="n">_methodInfo</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="nf">TryConvertValue</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="k">out</span> <span class="n">convertedValue</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span>
        <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span>
          <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">convert</span> <span class="k">value</span> <span class="k">from</span> <span class="n">type</span> <span class="p">{</span><span class="m">0</span><span class="p">}</span> <span class="n">to</span> <span class="n">type</span> <span class="p">{</span><span class="m">1</span><span class="p">}&amp;</span><span class="n">quot</span><span class="p">;,</span>
          <span class="p">(</span><span class="k">value</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">?</span> <span class="k">value</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">:</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="k">null</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span>
          <span class="n">_valuesType</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">_isSingleArgumentMethod</span> <span class="p">?</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="n">convertedValue</span> <span class="p">}</span> <span class="p">:</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="n">convertedValue</span><span class="p">,</span> <span class="n">context</span> <span class="p">};</span>
      <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="p">(</span><span class="n">ValidationResult</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!=</span> <span class="n">ValidationResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">&amp;&amp;</span> <span class="n">result</span><span class="p">.</span><span class="n">ErrorMessage</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">ErrorMessage</span> <span class="p">=</span> <span class="n">ErrorMessage</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">TargetInvocationException</span> <span class="n">exception</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">InnerException</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">throw</span> <span class="n">exception</span><span class="p">.</span><span class="n">InnerException</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="err">#</span><span class="n">endregion</span>

  <span class="err">#</span><span class="n">region</span> <span class="n">Private</span> <span class="n">Methods</span>

  <span class="k">private</span> <span class="kt">bool</span> <span class="nf">TryConvertValue</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="k">out</span> <span class="kt">object</span> <span class="n">convertedValue</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">convertedValue</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="n">Type</span> <span class="n">conversionType</span> <span class="p">=</span> <span class="n">_valuesType</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="p">(!</span><span class="n">conversionType</span><span class="p">.</span><span class="n">IsValueType</span> <span class="p">||</span> <span class="p">(</span><span class="n">conversionType</span><span class="p">.</span><span class="n">IsGenericType</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">conversionType</span><span class="p">.</span><span class="nf">GetGenericTypeDefinition</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Nullable</span><span class="p">&lt;&gt;))));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conversionType</span><span class="p">.</span><span class="nf">IsAssignableFrom</span><span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="nf">GetType</span><span class="p">()))</span>
    <span class="p">{</span>
      <span class="n">convertedValue</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">convertedValue</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ChangeType</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">conversionType</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">CurrentCulture</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">FormatException</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidCastException</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">NotSupportedException</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="err">#</span><span class="n">endregion</span>
<span class="p">}</span></code></pre></figure>

<p>A few notes here:</p>

<ul>
  <li>The constructor tries to find an appropriate method using reflection. If there are multiple overloads of the method then the one with 2 parameters will be chosen.</li>
  <li>The first parameter of the validation method can be of any type. Type conversion is attempted on the value to validate to match the method signature. I.e. the first (value) parameter can be object, string, int, etc.</li>
  <li>A generic error message can be supplied to the ConditionalValidationAttribute. If the validation method doesn’t set an error message when it returns a validation error, the ConditionalValidationAttribute.ErrorMessage property will be used.</li>
</ul>

<p>And a sample model <strong>User.cs</strong>:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">User</span> <span class="p">:</span> <span class="n">ModelBase</span>
<span class="p">{</span>
  <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">Country</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
  <span class="p">[</span><span class="nf">ConditionalValidation</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">User</span><span class="p">),</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ValidateState</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;)]</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">State</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="k">static</span> <span class="n">ValidationResult</span> <span class="nf">ValidateState</span><span class="p">(</span><span class="kt">string</span> <span class="n">state</span><span class="p">,</span> <span class="kt">object</span> <span class="n">context</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="n">context</span> <span class="k">as</span> <span class="n">User</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">context</span> <span class="k">is</span> <span class="n">not</span> <span class="n">of</span> <span class="n">type</span> <span class="n">User</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">context</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;);</span>

    <span class="kt">var</span> <span class="n">australianStates</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">VIC</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">TAS</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">NSW</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ACT</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">QLD</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">NT</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">WA</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">SA</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;};</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">Country</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Australia</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(!</span><span class="n">australianStates</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">StringComparer</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ValidationResult</span><span class="p">(&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">Australian</span> <span class="n">state</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">State</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Download the example by clicking the button below.</p>

<p><a class="btn btn-primary" href="/assets/files/ConditionalValidationExample.zip" title="Download the source for this example">Download source</a></p>



    <ul class="post-tags">
      
        <li><a href="/tag/aspnet" title="View posts tagged with aspnet">#aspnet</a></li>
      
        <li><a href="/tag/c#" title="View posts tagged with c#">#c#</a></li>
      
        <li><a href="/tag/mvc" title="View posts tagged with mvc">#mvc</a></li>
      
    </ul>

  </div><!-- end .container -->
</article>

<div class="stripe">
  <div class="container">

    <nav class="row pager">
      <div class="previous col-xs-6 col-sm-4">
        
          <div class="meta-label"><a href="/programming/using-linq-to-list-all-duplicates/"><span aria-hidden="true">&laquo;</span> Previous post</a></div>
          <div class="meta-value"><a href="/programming/using-linq-to-list-all-duplicates/">Using LINQ to list all duplicates</a></div>
        
      </div>
      <div class="next col-xs-6 col-sm-4 col-sm-offset-4">
        
          <div class="meta-label"><a href="/programming/delete-dependent-entities-when-removed-from-ef-collection/">Next post <span aria-hidden="true">&raquo;</span></a></div>
          <div class="meta-value"><a href="/programming/delete-dependent-entities-when-removed-from-ef-collection/">Delete Dependents When Removing an Entity From Entity Framework</a></div>
        
      </div>
    </nav><!-- end .post_nav -->

  </div><!-- end .container -->
</div><!-- end .stripe -->

    </main><!-- end .content -->

    
<footer role="contentinfo">
  <div class="container">

    <ul class="social-icons">
      <li><a href="https://twitter.com/pheasley" title="Follow me on Twitter"><i class="fa fa-twitter"></i></a></li>
      <li><a href="https://github.com/phdesign" title="See my code on GitHub"><i class="fa fa-github"></i></a></li>
      <li><a href="https://au.linkedin.com/in/pheasley" title="Connect with me on LinkedIn"><i class="fa fa-linkedin"></i></a></li>
      <li><a href="https://www.pinterest.com/paulheasley/" title="Follow me on Pinterest"><i class="fa fa-pinterest"></i></a></li>
      <li><a href="https://instagram.com/phdesign/" title="Me on Instagram"><i class="fa fa-instagram"></i></a></li>
    </ul>

    <p class="footer-copyright">
      &copy; 2015 Paul Heasley. All rights reserved. <br>
      Based on a <a href="http://guuthemes.com/" title="Much of the design of this site was based on a GuuThemes theme, big credit to their team for their beautiful art and clean code">GuuTheme</a>.
    </p>

  </div><!-- end .container -->
</footer>

    
<!-- JS (Javascript Files)
================================================== -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/assets/js/main.js"></script>

  </body>

</html>
