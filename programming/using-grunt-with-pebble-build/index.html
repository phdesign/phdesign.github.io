



<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Paul Heasley">
  

  <title>Using Grunt with Pebble Build to create scalable PebbleKit JavaScript | phdesign</title>
  <meta name="description" content="Pebble watchapps communicate with the phone via PebbleKit, a sandboxed JavaScript environment that runs within the Pebble phone app. It&#39;s pretty simple to se...">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="http://phdesign.com.au/programming/using-grunt-with-pebble-build/">
  <link rel="alternate" type="application/rss+xml" title="phdesign" href="/feed.xml">
  <link rel="shortcut icon" href="/favicon.ico">

  
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2414000-1', 'auto');
  ga('send', 'pageview');

</script>

  
  <script data-ad-client="ca-pub-5982856679845951" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- Google Web Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  
</head>

  <body class="post">

    <div class="header-background-image"></div>
    <header role="banner">
      <div class="header-top">
        
<nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/" title="phdesign homepage">ph<span class="brand-muted">design</span></a>
    </div><!-- end .navbar-header -->

    <div class="collapse navbar-collapse" id="navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/">Home <span class="sr-only">(current)</span></a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Blog <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            
              <li><a href="/programming">programming</a></li>
            
              <li><a href="/general">general</a></li>
            
              <li><a href="/woodworking">woodworking</a></li>
            
              <li><a href="/infosec">infosec</a></li>
            
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Projects <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/album-rsync">album-rsync</a></li>
            <li><a href="/npptoolbucket">NppToolBucket</a></li>
            <li><a href="/betternote">BetterNote</a></li>
            <li><a href="/phreplace">phReplace</a></li>
          </ul>
        </li>
        <li><a href="/presentations">Presentations</a></li>
        <li><a href="/contact">Contact me</a></li>
      </ul>

      

    </div><!-- end .navbar-collapse -->
  </div><!-- end .container -->
</nav>

      </div><!-- end .header-top -->

      

    </header>
    <main class="content" aria-label="Content">
  	  <article>
  <div class="container">

    <div class="date-stamp">
      <div class="month">Nov</div>
      <div class="day">09</div>
    </div><!-- end .date-stamp -->

    <h2 class="post-header">Using Grunt with Pebble Build to create scalable PebbleKit JavaScript</h2>

    <div class="meta-label">
      posted on <span class="meta-value muted">09 November 2015</span>
      
        in <span class="meta-value"><a href="/programming">programming</a></span>
      
    </div><!-- end .meta-label -->
    <br />

    
    
    
    
      <p class="deprecated alert alert-warning"><b>Warning:</b> Please consider that this post is over 5 years old and the content may no longer be relevant.</p>
    

    <!--
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5982856679845951"
     data-ad-slot="6503377131"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

-->
    <div class="alert alert-info" role="alert">
<a href="https://gist.github.com/phdesign/d46425bc4a2b72cd4802" title="Get the Gist" target="_blank">Want to skip to the code? Get the Gist here.</a>
</div>

<p>Pebble watchapps communicate with the phone via PebbleKit, a sandboxed JavaScript environment that runs within the Pebble phone app. It’s pretty simple to setup the interactions on the JavaScript side, but what happens when the JavaScript starts to get more complex? Using <a href="http://gruntjs.com/">Grunt</a> we can manage a scalable JS app, including running linters, bundling and running unit tests.</p>

<!--more-->

<h2 id="setting-up-grunt">Setting up Grunt</h2>

<p>To get started with Grunt, you’ll need to install Node and NPM (Node Package Manager). If you don’t already have it installed, get it from <a href="http://nodejs.org/">Nodejs</a>.
With Node installed, go to your pebble project directory and type</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm init</code></pre></figure>

<p>This will launch an interactive prompt to help setup your <em>package.json</em> file for your project. Answer the questions as needed or just accept the defaults.</p>

<p>Next we need to install Grunt. Run this command to install the Grunt CLI globally.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm install -g grunt-cli</code></pre></figure>

<p>We also need to add Grunt as a dependency for our project, to add your first dependency run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm install grunt --save-dev</code></pre></figure>

<p>Notice that this time we didn’t pass the <code class="highlighter-rouge">-g</code> flag to install it globally, so by default it will be added as a local dependency. Open the <em>package.json</em> file and note that grunt is now included under devDependencies. All of our dependencies will be dev dependencies (specified by the <code class="highlighter-rouge">--save-dev</code> flag), simply put we’re saying that to build the project you’ll need this dependency, but the compiled app doesn’t depend on any node packages to run. 
Also take notice of the <em>node_modules</em> folder that’s appeared in your project directory, this is where npm stores the files for any project dependencies. Go ahead and add this folder to your <em>.gitignore</em> / <em>.cvsignore</em> file, you don’t want it checked into source control.</p>

<p>Next create a new <em>Gruntfile.js</em> file in the root of your project directory, this file will define the tasks we want to run when building the watchapp. Add this empty Grunt configuration to the new file:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// The (empty) default task.</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">'default'</span><span class="p">,</span> <span class="p">[]);</span>

<span class="p">};</span></code></pre></figure>

<p>You can now check everything is setup properly by running this command from your project directory:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>grunt

Done, without errors.</code></pre></figure>

<h2 id="adding-jshint-to-check-code-quality">Adding JSHint to check code quality</h2>

<p>Now let’s add our first build task to Grunt, we’ll add <a href="http://jshint.com/">JSHint</a> which will check the quality of our JavaScript according to rules you can customise. First, add the dependency to the project</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm install grunt-contrib-jshint --save-dev</code></pre></figure>

<p>Open the <em>Gruntfile.js</em> and update it to the following</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>

    <span class="na">jshint</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">files</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'Gruntfile.js'</span><span class="p">,</span> 
        <span class="s1">'src/js/**/*.js'</span>
      <span class="p">],</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">jshintrc</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">},</span>

  <span class="p">});</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-contrib-jshint'</span><span class="p">);</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">'default'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'jshint'</span><span class="p">]);</span>

<span class="p">};</span></code></pre></figure>

<p>The line <code class="highlighter-rouge">grunt.loadNpmTasks('grunt-contrib-jshint');</code> is telling Grunt to reference the JSHint package and we’ve added jshint to the default build task <code class="highlighter-rouge">grunt.registerTask('default', ['jshint']);</code>.</p>

<p>The configuration of the task goes under <code class="highlighter-rouge">grunt.initConfig({</code>, you can find more details on how to customise the <a href="https://www.npmjs.com/package/grunt-contrib-jshint">grunt-contrib-jshint task on NPM</a>. In our example you’ll see we’re telling JSHint to check our Grunt file and any JavaScript file(s) in the <em>src/js/</em> folder. <code class="highlighter-rouge">jshintrc: true</code> tells the task to look for a <em>.jshintrc</em> file somewhere in the folder heirarchy relative to the file we’re checking, this file defines our rules for JSHint, below is a sample your can use or you can see all the possible rules <a href="https://github.com/jshint/jshint/blob/master/examples/.jshintrc">in the default configuration file</a>. Save the following to a <em>.jshintrc</em> file in your project root folder:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/*
* Example jshint configuration file for Pebble development.
* Adapted from http://developer.getpebble.com/blog/2014/01/12/Using-JSHint-For-Pebble-Development/
   *
* Check out the full documentation at http://www.jshint.com/docs/options/
   */</span>
   <span class="p">{</span>
   <span class="c1">// Declares the existence of a global 'Pebble' object</span>
   <span class="s2">"globals"</span><span class="err">:</span> <span class="p">{</span> <span class="s2">"Pebble"</span> <span class="err">:</span> <span class="kc">true</span> <span class="p">},</span>

  <span class="c1">// And standard objects (XMLHttpRequest and console)</span>
  <span class="s2">"browser"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">"devel"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">"node"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// Do not mess with standard JavaScript objects (Array, Date, etc)</span>
  <span class="s2">"freeze"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// Do not use eval! Keep this warning turned on (ie: false)</span>
  <span class="s2">"evil"</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="cm">/*
* The options below are more style/developer dependent.
   * Customize to your liking.
     */</span>

  <span class="c1">// Do not allow blocks without { }</span>
  <span class="s2">"curly"</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="c1">// Prohibits the use of immediate function invocations without wrapping them in parentheses</span>
  <span class="s2">"immed"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// Enforce indentation</span>
  <span class="s2">"indent"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// Do not use a variable before it's defined</span>
  <span class="s2">"latedef"</span><span class="err">:</span> <span class="s2">"nofunc"</span><span class="p">,</span>

  <span class="c1">// Spot undefined variables</span>
  <span class="s2">"undef"</span><span class="err">:</span> <span class="s2">"true"</span><span class="p">,</span>

  <span class="c1">// Spot unused variables</span>
  <span class="s2">"unused"</span><span class="err">:</span> <span class="s2">"true"</span><span class="p">,</span>

  <span class="c1">// Require capitalization of all constructor functions e.g. `new F()`</span>
  <span class="s2">"newcap"</span> <span class="err">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// Enforce use of single quotes (') everywhere</span>
  <span class="s2">"quotmark"</span> <span class="err">:</span> <span class="s2">"single"</span><span class="p">,</span>

  <span class="c1">// Tolerate use of `== null`</span>
  <span class="s2">"eqnull"</span> <span class="err">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="c1">// Supress dot notation warnings (e.g. allow obj['prop'])</span>
  <span class="s2">"sub"</span> <span class="err">:</span> <span class="kc">true</span>
<span class="p">}</span></code></pre></figure>

<p>With the changes made, lets run Grunt again, you should see the following if there are no errors in your JavaScript files.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>grunt

Done, without errors.</code></pre></figure>

<h2 id="bundling-javascript">Bundling JavaScript</h2>

<p>The next task we’ll add is bundling. This will combine all of our JavasScript files together into a single file, I do this because originally Pebble only supported a single file <em>src/js/pebble-js-app.js</em>, but with newer SDKs any JavaScript file in your <em>src/js/</em> will be built, so this step is optional.</p>

<p>Bundling using Grunt is usually done with <a href="https://www.npmjs.com/package/grunt-contrib-concat">grunt-contrib-concat</a>, followed by <a href="https://www.npmjs.com/package/grunt-contrib-uglify">grunt-contrib-uglify</a> if you also want to minify the result, you probably won’t want to minify your PebbleKit app however, because the reduction in size will be negligable (remember the JavaScript runs on your phone) but you’ll lose all benefit of debugging with log line numbers. For my project, I use <a href="https://www.npmjs.com/package/grunt-browserify">grunt-browserify</a>. This allows me to ignore the ordering / dependencies of the JavaScript files and just write JavaScript modules like a Node project, browserify will take care of the rest. Here’s an example of a browserify module:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">weather</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./weather.js'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>

  <span class="na">settings</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">configVersion</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">showWeather</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">weatherService</span><span class="p">:</span> <span class="s1">'yahoo-weather'</span>
  <span class="p">},</span>

  <span class="na">isRunningInEmulator</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Pebble</span><span class="p">.</span><span class="nx">getActiveWatchInfo</span> <span class="o">&amp;&amp;</span> <span class="sr">/^qemu/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">Pebble</span><span class="p">.</span><span class="nx">getActiveWatchInfo</span><span class="p">().</span><span class="nx">model</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="na">loadConfig</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
    <span class="p">}</span>
    
    <span class="nx">weather</span><span class="p">.</span><span class="nx">setWeatherService</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">weatherService</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Config loaded, using '</span> <span class="o">+</span> <span class="nx">weather</span><span class="p">.</span><span class="nx">activeService</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">' service'</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span></code></pre></figure>

<p>To add the task to our project, run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm install grunt-browserify --save-dev</code></pre></figure>

<p>Open the <em>Gruntfile.js</em> and update it to the following</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>

    <span class="na">jshint</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">files</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'Gruntfile.js'</span><span class="p">,</span> 
        <span class="s1">'src/js/**/*.js'</span>
      <span class="p">],</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">jshintrc</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="na">browserify</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">build</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">src</span><span class="p">:</span> <span class="p">[</span>
          <span class="s1">'src/js/**/*.js'</span><span class="p">,</span>
          <span class="s1">'!src/js/pebble-js-app.js'</span>
        <span class="p">],</span>
        <span class="na">dest</span><span class="p">:</span> <span class="s1">'src/js/pebble-js-app.js'</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">});</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-contrib-jshint'</span><span class="p">);</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-browserify'</span><span class="p">);</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">'default'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'jshint'</span><span class="p">,</span> <span class="s1">'browserify'</span><span class="p">]);</span>

<span class="p">};</span></code></pre></figure>

<p>The src files are specified using <a href="http://gruntjs.com/configuring-tasks#globbing-patterns">Grunt globbing</a>. <code class="highlighter-rouge">src/js/**/*.js</code> means find every JavaScript file in the <em>/src/js/</em> folder and any subfolders, and the <code class="highlighter-rouge">!src/js/pebble-js-app.js</code> says don’t include the <em>pebble-js-app.js</em> file, which is our output file.</p>

<h2 id="generating-an-appinfoh-file">Generating an appinfo.h file</h2>

<p>It can be very useful to have access to your <em>appinfo.json</em> data from your C code, like the name of the watchapp, the version or the list of appKeys, using Grunt this is a cinch. We’re going to use Grunt’s inbuilt templating facility to generate an <em>appinfo.h</em> file from a template. We’ll use the <a href="https://www.npmjs.com/package/grunt-contrib-copy">grunt-contrib-copy task</a> for this, go ahead and add it to your project:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm install grunt-contrib-copy --save-dev</code></pre></figure>

<p>Next update your Gruntfile to copy a <em>src/appinfo.tpl.h</em> file to <em>src/appinfo.h</em> and process the file as a Grunt template (for brevity I’ve replaced our previous config with …).</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">appConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">info</span><span class="p">:</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readJSON</span><span class="p">(</span><span class="s1">'appinfo.json'</span><span class="p">)</span>
  <span class="p">};</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>

    <span class="na">config</span><span class="p">:</span> <span class="nx">appConfig</span><span class="p">,</span>

    <span class="na">copy</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">main</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">process</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">files</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">'src/appinfo.h'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'src/appinfo.tpl.h'</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
    <span class="p">},</span>
    
    <span class="p">...</span>

  <span class="p">});</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-contrib-jshint'</span><span class="p">);</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-browserify'</span><span class="p">);</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-contrib-copy'</span><span class="p">);</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">'default'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'copy'</span><span class="p">,</span> <span class="s1">'jshint'</span><span class="p">,</span> <span class="s1">'browserify'</span><span class="p">]);</span>

<span class="p">};</span></code></pre></figure>

<p>Note the <code class="highlighter-rouge">appConfig</code>, we’re reading the <em>appinfo.json</em> file in so we can use the properties in our template file. Let’s create that template file in <em>src/appinfo.tpl.h</em></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#pragma once
</span>
<span class="cp">#define LONG_NAME "&lt;%= config.info.longName %&gt;"
#define VERSION_LABEL "&lt;%= config.info.versionLabel %&gt;"
#define UUID "&lt;%= config.info.uuid %&gt;"
</span>
<span class="o">&lt;%</span> <span class="k">for</span> <span class="p">(</span><span class="n">prop</span> <span class="n">in</span> <span class="n">config</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">appKeys</span><span class="p">)</span> <span class="p">{</span> 
  <span class="o">%&gt;</span><span class="err">#</span><span class="n">define</span> <span class="o">&lt;%=</span> <span class="n">prop</span> <span class="o">%&gt;</span> <span class="o">&lt;%=</span> <span class="n">config</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">appKeys</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span></code></pre></figure>

<p>If you now run our <code class="highlighter-rouge">grunt</code> command, you should find a sparkly new <em>src/appinfo.h</em> file that looks something like this:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#pragma once
</span>
<span class="cp">#define LONG_NAME "PHD"
#define VERSION_LABEL "1.1"
#define UUID "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
</span>
<span class="cp">#define KEY_TEMPERATURE 0
#define KEY_CONDITIONS 1
#define KEY_SHOW_WEATHER 2</span></code></pre></figure>

<h3 id="managing-secret-keys">Managing secret keys</h3>

<p>API keys and usernames / passwords should be left out of your code for security reasons, a simple way to manage these using our Grunt setup is to creating a <em>keys.json</em> file in the root of the project. For JavaScript files, if you’re using Browserify you can simply include the keys like so:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../../../keys.json'</span><span class="p">);</span></code></pre></figure>

<p>And if you’re generating a <em>appinfo.h</em> file, you can load the keys into the Grunt appConfig:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">var</span> <span class="nx">appConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">info</span><span class="p">:</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readJSON</span><span class="p">(</span><span class="s1">'appinfo.json'</span><span class="p">),</span>
    <span class="na">keys</span><span class="p">:</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readJSON</span><span class="p">(</span><span class="s1">'keys.json'</span><span class="p">)</span>
  <span class="p">};</span></code></pre></figure>

<p>And use these in your <em>appinfo.tpl.h</em> file. e.g.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;%</span> <span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">config</span><span class="p">.</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span> 
  <span class="o">%&gt;</span><span class="err">#</span><span class="nx">define</span> <span class="nx">KEY_</span><span class="o">&lt;%=</span> <span class="nx">prop</span> <span class="o">%&gt;</span> <span class="o">&lt;%=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span></code></pre></figure>

<h2 id="integrating-grunt-into-pebble-build">Integrating Grunt into pebble build</h2>

<p>Now that we’ve got a sweet Grunt setup, it’d be awesome if we could run the <code class="highlighter-rouge">grunt</code> task every time we did a <code class="highlighter-rouge">pebble build</code>. Well it turns out that it’s pretty simple, we just need to modify the wscript file in your project root. Add <code class="highlighter-rouge">from sh import grunt</code> under the first import file statement, then call <code class="highlighter-rouge">grunt()</code> within the <code class="highlighter-rouge">def build(ctx):</code> task.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">import</span> <span class="n">os</span><span class="p">.</span><span class="nf">path</span>
<span class="n">from</span> <span class="n">sh</span> <span class="n">import</span> <span class="n">grunt</span>

<span class="n">top</span> <span class="o">=</span> <span class="s1">'.'</span>
<span class="n">out</span> <span class="o">=</span> <span class="s1">'build'</span>

<span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s1">'pebble_sdk'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s1">'pebble_sdk'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s1">'pebble_sdk'</span><span class="p">)</span>

    <span class="n">grunt</span><span class="p">()</span>

    <span class="n">build_worker</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s1">'worker_src'</span><span class="p">)</span>
    <span class="n">binaries</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="nb">p</span> <span class="k">in</span> <span class="n">ctx</span><span class="p">.</span><span class="nf">env</span><span class="o">.</span><span class="no">TARGET_PLATFORMS</span><span class="p">:</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">set_env</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="nf">all_envs</span><span class="p">[</span><span class="nb">p</span><span class="p">])</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">set_group</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="nf">env</span><span class="o">.</span><span class="no">PLATFORM_NAME</span><span class="p">)</span>
        <span class="n">app_elf</span><span class="o">=</span><span class="s1">'{}/pebble-app.elf'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="nf">env</span><span class="o">.</span><span class="no">BUILD_DIR</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">pbl_program</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ctx</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">ant_glob</span><span class="p">(</span><span class="s1">'src/**/*.c'</span><span class="p">),</span>
        <span class="n">target</span><span class="o">=</span><span class="n">app_elf</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="ss">build_worker:
            </span><span class="n">worker_elf</span><span class="o">=</span><span class="s1">'{}/pebble-worker.elf'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="nf">env</span><span class="o">.</span><span class="no">BUILD_DIR</span><span class="p">)</span>
            <span class="n">binaries</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="s1">'platform'</span><span class="p">:</span> <span class="nb">p</span><span class="p">,</span> <span class="s1">'app_elf'</span><span class="p">:</span> <span class="n">app_elf</span><span class="p">,</span> <span class="s1">'worker_elf'</span><span class="p">:</span> <span class="n">worker_elf</span><span class="p">})</span>
            <span class="n">ctx</span><span class="p">.</span><span class="nf">pbl_worker</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ctx</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">ant_glob</span><span class="p">(</span><span class="s1">'worker_src/**/*.c'</span><span class="p">),</span>
            <span class="n">target</span><span class="o">=</span><span class="n">worker_elf</span><span class="p">)</span>
        <span class="ss">else:
            </span><span class="n">binaries</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="s1">'platform'</span><span class="p">:</span> <span class="nb">p</span><span class="p">,</span> <span class="s1">'app_elf'</span><span class="p">:</span> <span class="n">app_elf</span><span class="p">})</span>
    
    <span class="n">ctx</span><span class="p">.</span><span class="nf">set_group</span><span class="p">(</span><span class="s1">'bundle'</span><span class="p">)</span>
    <span class="n">ctx</span><span class="p">.</span><span class="nf">pbl_bundle</span><span class="p">(</span><span class="n">binaries</span><span class="o">=</span><span class="n">binaries</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="n">ctx</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">ant_glob</span><span class="p">(</span><span class="s1">'src/js/pebble-js-app.js'</span><span class="p">))</span></code></pre></figure>

<p>Also note on the last line we’re telling the build system to just use our single, bundled JavaScript file <em>src/js/pebble-js-app.js</em>.</p>

<p>Now when you run <code class="highlighter-rouge">pebble build</code> it will call our Grunt system, lint and bundle the JavaScript and generate an <em>appinfo.h</em> file.</p>

<p>All in a good day’s work.</p>


    <ul class="post-tags">
      
        <li><a href="/tag/grunt" title="View posts tagged with grunt">#grunt</a></li>
      
        <li><a href="/tag/pebble" title="View posts tagged with pebble">#pebble</a></li>
      
    </ul>

  </div><!-- end .container -->
</article>

<div class="stripe">
  <div class="container">

    <nav class="row pager">
      <div class="previous col-xs-6 col-sm-4">
        
          <div class="meta-label"><a href="/programming/github-pages-jekyll-and-grunt/"><span aria-hidden="true">&laquo;</span> Previous post</a></div>
          <div class="meta-value"><a href="/programming/github-pages-jekyll-and-grunt/">Replace your CMS with GitHub Pages, Jekyll and Grunt</a></div>
        
      </div>
      <div class="next col-xs-6 col-sm-4 col-sm-offset-4">
        
          <div class="meta-label"><a href="/general/adding-font-awesome-icons-to-google-slides/">Next post <span aria-hidden="true">&raquo;</span></a></div>
          <div class="meta-value"><a href="/general/adding-font-awesome-icons-to-google-slides/">Adding font-awesome (or any SVG) to Google Slides</a></div>
        
      </div>
    </nav><!-- end .post_nav -->

  </div><!-- end .container -->
</div><!-- end .stripe -->

    </main><!-- end .content -->

    
<footer role="contentinfo">
  <div class="container">

    <ul class="social-icons">
      <li><a href="https://twitter.com/pheasley" title="Follow me on Twitter"><i class="fa fa-twitter"></i></a></li>
      <li><a href="https://github.com/phdesign" title="See my code on GitHub"><i class="fa fa-github"></i></a></li>
      <li><a href="https://au.linkedin.com/in/pheasley" title="Connect with me on LinkedIn"><i class="fa fa-linkedin"></i></a></li>
      <li><a href="https://www.pinterest.com/paulheasley/" title="Follow me on Pinterest"><i class="fa fa-pinterest"></i></a></li>
      <li><a href="https://instagram.com/phdesign/" title="Me on Instagram"><i class="fa fa-instagram"></i></a></li>
    </ul>

    <p class="footer-copyright">
      &copy; 2015 Paul Heasley. All rights reserved. <br>
      Based on a <a href="http://guuthemes.com/" title="Much of the design of this site was based on a GuuThemes theme, big credit to their team for their beautiful art and clean code">GuuTheme</a>.
    </p>

  </div><!-- end .container -->
</footer>

    
<!-- JS (Javascript Files)
================================================== -->

<script src="/assets/js/search.min.js"></script>
<script src="/assets/js/main.js"></script>

  </body>

</html>
